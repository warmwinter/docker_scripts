FROM php:7.4-fpm-alpine

LABEL Description="Discuz! X Release Docker" Vendor="Discuz! Team" Version="1.0.0"

# ENV
## MySQL/MariaDB
## Nginx
## PHP
ENV php_conf_d /usr/local/etc/php/conf.d/
ENV ALPINE_VERSION 3.13
ENV IGBINARY_VER 3.2.1
ENV REDIS_VER 5.3.2
ENV MCRYPT_VER 1.0.4
ENV MYSQL_VER master
## Redis
## User
ENV MYSQL_UG mysql
ENV NGINX_UG nginx
ENV PHP_UG apache
ENV PHP_UG_ID 48
ENV REDIS_UG redis

# Packages
ENV PERSIST_DEPS \
    vim \
    curl \
    git \
    mariadb mariadb-client \
    nginx \
    redis \
    supervisor

ENV TMP_DEPS \
    $PHPIZE_DEPS \
    tzdata

RUN set -xe \
    && mv /etc/apk/repositories /etc/apk/repositories.bak \
    && echo "https://mirrors.aliyun.com/alpine/v${ALPINE_VERSION}/main" > /etc/apk/repositories \
    && echo "https://mirrors.aliyun.com/alpine/v${ALPINE_VERSION}/community" >> /etc/apk/repositories \
#
# Modify resolve.conf, use AliDNS (www.alidns.com)
    && echo '# Generated by NetworkManager' > /etc/resolv.conf \
    && echo 'nameserver 223.5.5.5' >> /etc/resolv.conf \
    && echo 'nameserver 223.6.6.6' >> /etc/resolv.conf \
#
# Install packages, set system
    && apk add --no-cache --virtual .system-deps $PERSIST_DEPS \
    && apk add --no-cache --virtual .build-deps $TMP_DEPS \
    && cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime \
    && echo 'Asia/Shanghai' > /etc/timezone \
    && date \
#
# Create source dolder
    && mkdir -p /usr/src /web/wwwroot /web/data /web/conf \
#
# clean apk build deps
    && apk del .build-deps

STOPSIGNAL SIGQUIT

EXPOSE 80 443

CMD ["supervisord", "-n"]